<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ â€” ã‚³ã‚³ã‚¹ã‚¯</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/cocotimeline.css') }}">

  <style>
    .modal-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }

    #postImagePreview {
      max-width: 100%;
      max-height: 150px;
      margin-bottom: 10px;
      border-radius: 10px;
      display: none;
    }

    .post-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .post-image {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }

    .post-footer {
      margin-top: 12px;
      display: flex;
      gap: 16px;
      align-items: center;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- ãƒ–ãƒ©ãƒ³ãƒ‰ -->
    <div class="brand">
      <div class="logo">
        <img src="{{ url_for('static', filename='image/Cocosku_logo2.png') }}" alt="ã‚³ã‚³ã‚¹ã‚¯ ãƒ­ã‚´">
      </div>
      <div class="app-name">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
    </div>

    <!-- æŠ•ç¨¿ä¸€è¦§ -->
    <div id="feed">
      {% if posts %}
      {% include 'post_items.html' %}
      {% else %}
      <div class="no-posts-msg" style="text-align:center; color:var(--muted); margin-top:30px;">
        æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŠ•ç¨¿ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
      </div>
      {% endif %}
    </div>

    <!-- ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ã‚»ãƒ³ã‚µãƒ¼ -->
    <div id="sentinel" style="height: 50px; text-align: center; color: #888; margin-bottom: 60px;">
      Loading...
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        let loading = false;
        let finished = false;

        // ç›£è¦–ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
        const sentinel = document.getElementById("sentinel");

        const observer = new IntersectionObserver(async (entries) => {
          if (loading || finished) return;

          if (entries[0].isIntersecting) {
            loading = true;

            // æœ€å¾Œã®æŠ•ç¨¿ã®ä½œæˆæ—¥æ™‚ã‚’å–å¾—
            const posts = document.querySelectorAll(".post-card");
            if (posts.length === 0) {
              loading = false;
              return;
            }

            const lastPost = posts[posts.length - 1];
            const lastCreatedAt = lastPost.dataset.createdAt;

            if (!lastCreatedAt) {
              loading = false;
              return;
            }

            try {
              // API fetch
              // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã«å«ã¾ã‚Œã‚‹ã‚¹ãƒšãƒ¼ã‚¹ãªã©ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
              const res = await fetch(`/api/timeline?last_created_at=${encodeURIComponent(lastCreatedAt)}`);
              const data = await res.json();

              if (data.html) {
                // HTMLã‚’è¿½åŠ 
                const feed = document.getElementById("feed");
                feed.insertAdjacentHTML('beforeend', data.html);

                // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸè¦ç´ ã«å¯¾ã—ã¦ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã§
                // ï¼ˆã„ã„ã­ãƒœã‚¿ãƒ³ãªã©ã¯ event delegation ã‹å†è¨­å®šãŒå¿…è¦ï¼‰
                // ä»Šå›ã¯ simplisity ã®ãŸã‚ã€å†è¨­å®šé–¢æ•°ã‚’å‘¼ã¶å½¢ãªã©ãŒæœ›ã¾ã—ã„ãŒ
                // DOMContentLoadedå†…ã® like-btn ã‚¤ãƒ™ãƒ³ãƒˆã¯æ—¢å­˜è¦ç´ ã«ã—ã‹åŠ¹ã‹ãªã„ã€‚
                // â†’ event delegation (è¦ªè¦ç´ ç›£è¦–) ã«æ›¸ãæ›ãˆã‚‹æ–¹ãŒãƒ™ã‚¿ãƒ¼ã ãŒã€
                // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«å†å®Ÿè¡Œã™ã‚‹é–¢æ•°ã‚’ä½œã‚‹ã‹ã€delegationå®Ÿè£…ã‚’æ¨å¥¨ã€‚
                attachLikeEvents();

              }

              if (!data.has_next) {
                finished = true;
                sentinel.style.display = "none";
              }
            } catch (e) {
              console.error("Fetch error:", e);
            } finally {
              loading = false;
            }
          }
        }, { rootMargin: "100px" });

        observer.observe(sentinel);

        // ã„ã„ã­ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šé–¢æ•°ï¼ˆå†åˆ©ç”¨å¯èƒ½ã«ï¼‰
        function attachLikeEvents() {
          // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã¨é‡è¤‡ã—ãªã„ã‚ˆã†å·¥å¤«ãŒå¿…è¦ã ãŒã€
          // ç°¡æ˜“çš„ã«ã¯ .like-btn:not(.bound) ã®ã‚ˆã†ã«ã‚¯ãƒ©ã‚¹ä»˜ä¸ã§ç®¡ç†
          document.querySelectorAll(".like-btn:not(.bound)").forEach((btn) => {
            btn.classList.add("bound");
            btn.addEventListener("click", handleLike);
          });
        }

        async function handleLike(e) {
          const btn = e.currentTarget;
          const postId = btn.dataset.postId;
          const response = await fetch(`/like/${postId}`, { method: "POST" });
          if (!response.ok) { alert("ã„ã„ã­ã‚¨ãƒ©ãƒ¼"); return; }
          const data = await response.json();
          const postCard = btn.closest(".post-card");
          const countSpan = postCard.querySelector(".like-count");
          let current = parseInt(countSpan.innerText);
          countSpan.innerText = data.liked ? current + 1 : current - 1;
        }

        // åˆå›å®Ÿè¡Œ
        attachLikeEvents();
      });
    </script>




    <!-- æŠ•ç¨¿ãƒœã‚¿ãƒ³ -->
    <div class="fab" onclick="openModal()">+</div>

    <!-- æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-bg" id="modalBg" style="display:none;">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">Ã—</button>
        <h3>æ–°è¦æŠ•ç¨¿</h3>

        <form id="postForm" action="{{ url_for('post') }}" method="POST" enctype="multipart/form-data">
          <textarea name="content" id="postText" placeholder="ä»Šè€ƒãˆã¦ã„ã‚‹ã“ã¨ã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†ï¼"></textarea>

          <img id="postImagePreview">

          <div id="ai-result" style="margin: 10px 0; padding: 10px; border-radius: 8px; display: none;"></div>

          <input type="file" name="image" id="postImage" accept="image/*" onchange="previewImage(event)">

          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
            <button type="button" onclick="checkFlamingRisk()" class="post-btn" style="background: #6c5ce7;">ğŸ¤–
              AIãƒã‚§ãƒƒã‚¯</button>
            <button type="submit" class="post-btn">æŠ•ç¨¿</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      async function checkFlamingRisk() {
        const text = document.getElementById("postText").value;
        const fileInput = document.getElementById("postImage");
        const resultDiv = document.getElementById("ai-result");

        if (!text && fileInput.files.length === 0) {
          alert("ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯ç”»åƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        resultDiv.style.display = "block";
        resultDiv.style.background = "#f0f0f0";
        resultDiv.style.color = "#333";
        resultDiv.innerHTML = "ğŸ¤– AIãŒåˆ¤å®šä¸­...<br><span style='font-size:0.8rem;'>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</span>";

        const formData = new FormData();
        formData.append("content", text);
        if (fileInput.files.length > 0) {
          formData.append("image", fileInput.files[0]);
        }

        try {
          const res = await fetch("/api/ai_check", {
            method: "POST",
            body: formData
          });

          if (!res.ok) {
            resultDiv.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            return;
          }

          const data = await res.json();

          // çµæœè¡¨ç¤º
          if (data.percentage >= 0) {
            let color = "#2ecc71"; // å®‰å…¨
            if (data.percentage >= 40) color = "#f1c40f"; // æ³¨æ„
            if (data.percentage >= 70) color = "#e74c3c"; // å±é™º

            resultDiv.style.background = color + "20"; // è–„ã„èƒŒæ™¯
            resultDiv.style.color = "#333";
            resultDiv.style.border = `1px solid ${color}`;

            resultDiv.innerHTML = `
                <div style="font-weight:bold; color:${color}; font-size:1.1rem;">
                    ç‚ä¸Šç¢ºç‡ ${data.percentage}%
                </div>
                <div style="font-size:0.9rem; margin-top:5px;">
                    ${data.reason}
                </div>
            `;
          } else {
            resultDiv.innerText = "åˆ¤å®šã§ãã¾ã›ã‚“ã§ã—ãŸ";
          }

        } catch (e) {
          console.error(e);
          resultDiv.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
        }
      }
    </script>

    <!-- ãƒªãƒ—ãƒ©ã‚¤ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-bg" id="replyModal" style="display:none;">
      <div class="modal-content reply-modal-content">
        <button class="modal-close" onclick="closeReplyModal()">Ã—</button>
        <h4>ãƒªãƒ—ãƒ©ã‚¤</h4>

        <form id="replyForm" method="POST">
          <textarea name="reply" placeholder="ãƒªãƒ—ãƒ©ã‚¤ã‚’å…¥åŠ›"
            style="width: 95%; height: 120px; padding: 8px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc;">
      </textarea>

          <button class="post-btn" type="submit">é€ä¿¡</button>
        </form>

      </div>
    </div>



    <!-- ãƒŠãƒ“ãƒãƒ¼ -->
    <div class="nav-bar">
      <a href="{{ url_for('timeline') }}" class="nav-item">ğŸ  TL</a>
      <a href="{{ url_for('search_page') }}" class="nav-item">ğŸ” æ¤œç´¢</a>
      <a href="{{ url_for('notifications') }}" class="nav-item">ğŸ”” é€šçŸ¥</a>
      <a href="{{ url_for('dm') }}" class="nav-item">ğŸ’¬ DM</a>
      <a href="{{ url_for('profile') }}" class="nav-item active">ğŸ‘¤ ãƒ—ãƒ­ãƒ•</a>
      <a href="{{ url_for('calendar_password') }}" class="nav-item">ğŸ“… äºˆå®š</a>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/cocotimeline.js') }}"></script>

</body>

</html>