<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ â€” ã‚³ã‚³ã‚¹ã‚¯</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/cocotimeline.css') }}">

  <style>
    .modal-close {
      position: absolute;
      top: 8px;
      right: 8px;
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
    #postImagePreview {
      max-width: 100%;
      max-height: 150px;
      margin-bottom: 10px;
      border-radius: 10px;
      display: none;
    }

    .post-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .post-image {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }
    .post-footer {
      margin-top: 12px;
      display: flex;
      gap: 16px;
      align-items: center;
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- ãƒ–ãƒ©ãƒ³ãƒ‰ -->
    <div class="brand">
      <div class="logo">
        <img src="{{ url_for('static', filename='image/Cocosku_logo2.png') }}" alt="ã‚³ã‚³ã‚¹ã‚¯ ãƒ­ã‚´">
      </div>
      <div class="app-name">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>
    </div>

    <!-- æŠ•ç¨¿ä¸€è¦§ -->
<div id="feed">
  {% if posts %}
    {% for post in posts %}
      <div class="post-card" data-post-id="{{ post.id }}">
        <div class="post-header">

          <!-- ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆæŠ¼ã—ãŸã‚‰ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸ï¼‰ -->
          <div class="icon"
               onclick="window.location.href='/user/{{ post.user_id }}'">
            {% if post.user_avatar_url %}
              <img src="{{ post.user_avatar_url }}"
                   style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
            {% else %}
              {{ post.user_name[0] }}
            {% endif %}
          </div>
        
          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆæŠ¼ã—ãŸã‚‰ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã¸ï¼‰ -->
          <div class="user-name"
               style="cursor:pointer;"
               onclick="window.location.href='/user/{{ post.user_id }}'">
            {{ post.user_name }}
          </div>
        
        </div>
        
        

        <div class="post-content">
          {{ post.content | replace('\n', '<br>') | safe }}
        </div>

        {% if post.image_url %}
          <img src="{{ post.image_url }}" class="post-image">
        {% endif %}

        <div class="post-footer">

          <!-- â¤ï¸ ã„ã„ã­ãƒœã‚¿ãƒ³ -->
          <button class="like-btn"
            data-post-id="{{ post.id }}">
            â¤ï¸
          </button>

          <!-- â¤ï¸ ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤º -->
          <span class="like-count">
            {{ post.likes | length }}
          </span>

          <button class="reply-btn" onclick="openReplyModal('{{ post.id }}')">
            ğŸ’¬ ãƒªãƒ—ãƒ©ã‚¤ ({{ post.replies_count | default(0) }})
          </button>
          
          {% if post.user_id == user.uid %}
            <button class="delete-btn"
              onclick="confirmDeletePost('{{ post.id }}')">
              ğŸ—‘ å‰Šé™¤
            </button>
          {% endif %}

        </div>
        
        <!-- ğŸ”½ ãƒªãƒ—ãƒ©ã‚¤ï¼ˆ3ä»¶ã¾ã§è¡¨ç¤ºï¼‰-->
        {% if post.replies %}
          <div class="reply-list">
            {% for reply in post.replies[:3] %}
              <div class="reply-item">
                <strong>{{ reply.user_name }}</strong> ï¼š
                <span>{{ reply.content | replace('\n', '<br>') | safe }}</span>

                {% if reply.user_id == user.uid %}
                  <form action="{{ url_for('delete_reply', post_id=post.id, reply_id=reply.id) }}" method="POST" style="display:inline;">
                    <button class="delete-reply-btn">å‰Šé™¤</button>
                  </form>
                {% endif %}
              </div>
            {% endfor %}

            <!-- â–¼ ä»–ã®ãƒªãƒ—ãƒ©ã‚¤è¡¨ç¤ºãƒœã‚¿ãƒ³ -->
            {% if post.replies | length > 3 %}
              <div class="reply-toggle" onclick="toggleReplies('{{ post.id }}')"
                id="toggle-btn-{{ post.id }}">
                ä»– {{ post.replies | length - 3 }} ä»¶ã®ãƒªãƒ—ãƒ©ã‚¤ã‚’è¦‹ã‚‹
              </div>

              <div class="reply-hidden" id="hidden-replies-{{ post.id }}" style="display:none;">
                {% for reply in post.replies[3:] %}
                  <div class="reply-item">
                    <strong>{{ reply.user_name }}</strong> ï¼š
                    <span>{{ reply.content | replace('\n', '<br>') | safe }}</span>

                    {% if reply.user_id == user.uid %}
                      <form action="{{ url_for('delete_reply', post_id=post.id, reply_id=reply.id) }}"
                        method="POST" style="display:inline;">
                        <button class="delete-reply-btn">å‰Šé™¤</button>
                      </form>
                    {% endif %}
                  </div>
                {% endfor %}

                <div class="reply-toggle-close"
                  onclick="toggleReplies('{{ post.id }}')">
                  ä»– {{ post.replies | length - 3 }} ä»¶ã®ãƒªãƒ—ãƒ©ã‚¤ã‚’é–‰ã˜ã‚‹
                </div>
              </div>
            {% endif %}

          </div>
        {% endif %}


      </div>
    {% endfor %}
  {% else %}
    <div style="text-align:center; color:var(--muted); margin-top:30px;">
      æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŠ•ç¨¿ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
    </div>
  {% endif %}
</div>

<!-- â–¼ ã„ã„ã­å‡¦ç†ã®JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".like-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const postId = btn.dataset.postId;

      const response = await fetch(`/like/${postId}`, {
        method: "POST"
      });

      if (!response.ok) {
        alert("ã„ã„ã­ã§ãã¾ã›ã‚“ã§ã—ãŸâ€¦");
        return;
      }

      const data = await response.json();

      // ã‚«ã‚¦ãƒ³ãƒˆéƒ¨åˆ†ã®å–å¾—
      const postCard = btn.closest(".post-card");
      const countSpan = postCard.querySelector(".like-count");
      let current = parseInt(countSpan.innerText);

      // ãƒ‡ãƒ¼ã‚¿ã«å¿œã˜ã¦å¢—æ¸›
      if (data.liked) {
        countSpan.innerText = current + 1;
      } else {
        countSpan.innerText = current - 1;
      }
    });
  });
});
</script>

    

    <!-- æŠ•ç¨¿ãƒœã‚¿ãƒ³ -->
    <div class="fab" onclick="openModal()">+</div>

    <!-- æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal-bg" id="modalBg" style="display:none;">
      <div class="modal-content">
        <button class="modal-close" onclick="closeModal()">Ã—</button>
        <h3>æ–°è¦æŠ•ç¨¿</h3>

        <form id="postForm" action="{{ url_for('post') }}" method="POST" enctype="multipart/form-data">
          <textarea name="content" id="postText" placeholder="ä»Šè€ƒãˆã¦ã„ã‚‹ã“ã¨ã‚’ã‚·ã‚§ã‚¢ã—ã‚ˆã†ï¼"></textarea>

          <img id="postImagePreview">

          <input type="file" name="image" id="postImage" accept="image/*" onchange="previewImage(event)">
          
          <button type="submit" class="post-btn">æŠ•ç¨¿</button>
        </form>
      </div>
    </div>

    <!-- ãƒªãƒ—ãƒ©ã‚¤ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="replyModal" style="display:none;">
  <div class="modal-content reply-modal-content">
    <button class="modal-close" onclick="closeReplyModal()">Ã—</button>
    <h4>ãƒªãƒ—ãƒ©ã‚¤</h4>

    <form id="replyForm" method="POST">
      <textarea name="reply" 
          placeholder="ãƒªãƒ—ãƒ©ã‚¤ã‚’å…¥åŠ›"
          style="width: 95%; height: 120px; padding: 8px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc;">
      </textarea>

      <button class="post-btn" type="submit">é€ä¿¡</button>
    </form>

  </div>
</div>



    <!-- ãƒŠãƒ“ãƒãƒ¼ -->
    <div class="nav-bar">
      <a href="{{ url_for('timeline') }}" class="nav-item active">ğŸ  TL</a>
      <a href="#" class="nav-item">ğŸ” æ¤œç´¢</a>
      <a href="#" class="nav-item">ğŸ”” é€šçŸ¥</a>
      <a href="#" class="nav-item">ğŸ’¬ DM</a>
      <a href="{{ url_for('profile') }}" class="nav-item">ğŸ‘¤ ãƒ—ãƒ­ãƒ•</a>
      <a href="#" class="nav-item">ğŸ“… äºˆå®š</a>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/cocotimeline.js') }}"></script>

</body>
</html>
